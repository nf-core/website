<script lang="ts">
    import { onMount } from "svelte";
    interface Props {
        light?: import("svelte").Snippet;
        dark?: import("svelte").Snippet;
    }

    let { light, dark }: Props = $props();

    let theme = $state("dark");

    function setTheme(theme) {
        //NOTE: same as in BaseHead.astro
        const root = document.documentElement;
        if (theme === "auto") {
            if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                root.setAttribute("data-bs-theme", "dark");
            } else {
                root.setAttribute("data-bs-theme", "light");
            }
        } else {
            root.setAttribute("data-bs-theme", theme);
        }
    }
    function switchTheme(e) {
        const target = e.target;
        let theme = "";
        // check if we clicked on svg or if target doesn't have a title attribute
        if (target.tagName !== "div" || !target.title) {
            // get the parent div
            theme = target.closest("div.theme-option").title;
        } else {
            theme = e.target.title;
        }
        localStorage.setItem("theme", theme);
        setTheme(theme);
        window.dispatchEvent(new Event("theme-changed"));
    }

    onMount(() => {
        theme = document.documentElement.getAttribute("data-bs-theme") || "auto";
        window.addEventListener("theme-changed", (e) => {
            theme = document.documentElement.getAttribute("data-bs-theme");
        });
    });
</script>

<div class="dropdown" title="Change theme" data-bs-toggle="tooltip" data-bs-placement="bottom">
    <button
        class="nav-link dropdown-toggle"
        type="button"
        data-bs-toggle="dropdown"
        aria-expanded="false"
        title="Change theme button"
    >
        <i class="theme-icon-light" class:d-none={theme !== "light"}>
            {@render light?.()}
        </i>
        <i class="theme-icon-dark" class:d-none={theme !== "dark"}>
            {@render dark?.()}
        </i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
        <li><span class="dropdown-header">Select theme</span></li>
        <li class="dropdown-item" class:active={theme === "light"}>
            <div
                class="text-decoration-none theme-option w-100"
                id="theme-light"
                title="light"
                onclick={(e) => switchTheme(e)}
                onkeydown={(e) => switchTheme(e)}
                role="button"
                tabindex="0"
            >
                {@render light?.()} <span class="ms-1">Light</span>
            </div>
        </li>
        <li class="dropdown-item" class:active={theme === "dark"}>
            <div
                class="text-decoration-none theme-option w-100"
                id="theme-dark"
                title="dark"
                onclick={(e) => switchTheme(e)}
                onkeydown={(e) => switchTheme(e)}
                role="button"
                tabindex="0"
            >
                {@render dark?.()} <span class="ms-1">Dark</span>
            </div>
        </li>
        <li class="dropdown-item">
            <div
                class="text-decoration-none theme-option w-100"
                id="theme-auto"
                title="auto"
                onclick={(e) => switchTheme(e)}
                onkeydown={(e) => switchTheme(e)}
                role="button"
                tabindex="0"
            >
                <i class="fa-solid fa-adjust"></i> <span class="ms-1">System</span>
            </div>
        </li>
    </ul>
</div>

<style lang="scss">
    .theme-option {
        cursor: pointer;
    }
</style>
