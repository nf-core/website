---
import PageLayout from "@layouts/PageLayout.astro";
import { getCollection } from "astro:content";
import type { SidebarEntry } from "@utils/types";
import { addEntriesToSection, sanitizeNfCoreLabels } from "@utils/functions";
import { Icon } from "astro-icon/components";
import SidebarNav from "@components/sidebar/SidebarNav.astro";

let docs = await getCollection("docs");

let sections: SidebarEntry[] = [
    {
        type: "group",
        id: "get-started",
        label: "Get started",
        entries: [],
        collapsed: true,
        icon: "octicon:play-16",
        weight: 1,
    },
    {
        type: "group",
        id: "users",
        label: "Users",
        entries: [],
        collapsed: true,
        icon: "octicon:git-branch-16",
        weight: 2,
    },
    {
        type: "group",
        id: "developers",
        label: "Developers",
        entries: [],
        collapsed: true,
        icon: "octicon:git-commit-16",
        weight: 3,
    },
    {
        type: "group",
        id: "contributors",
        label: "Contributors",
        entries: [],
        collapsed: true,
        icon: "octicon:git-pull-request-16",
        weight: 4,
    },
    {
        type: "group",
        id: "specifications",
        label: "Specifications",
        entries: [],
        collapsed: true,
        icon: "octicon:checklist-16",
        weight: 5,
    },
    {
        type: "group",
        id: "community",
        label: "Community",
        entries: [],
        collapsed: true,
        icon: "mdi:sprout",
        weight: 6,
    },
    {
        type: "group",
        id: "nf-core-tools",
        label: "nf-core/tools",
        entries: [],
        collapsed: true,
        icon: "octicon:tools-16",
        weight: 7,
    },
];

addEntriesToSection(sections, docs, Astro.url.pathname);
// sort all entries by weight if available recursively
const sortEntries = (entries: SidebarEntry[]) => {
    entries.sort((a, b) => {
        if (a.weight && !b.weight) {
            return -1;
        } else if (!a.weight && b.weight) {
            return 1;
        } else if (a.weight && b.weight && a.weight !== b.weight) {
            if (a.weight < b.weight) {
                return -1;
            } else if (a.weight > b.weight) {
                return 1;
            }
        } else {
            return a.label.localeCompare(b.label);
        }
    });
    entries.forEach((entry) => {
        if (entry.type === "group" && entry.entries) {
            sortEntries(entry.entries);
        }
    });
};

sections.forEach((section) => {
    sortEntries(section.entries);
});

const findEntriesWithLabel = (sections: SidebarEntry[], label: string, parentLabel: string | undefined) => {
    let entries = [];
    sections.forEach((section) => {
        if (!parentLabel && section.label === label) {
            section.metadata = docs.find((doc) => "/docs/" + doc.id.replace(/\.[^/.]+$/, "") === section.href);
            entries.push(section);
        }
        if (parentLabel && section.label === parentLabel) {
            section.entries.forEach((entry) => {
                if (entry.label === label) {
                    entry.metadata = docs.find((doc) => "/docs/" + doc.id.replace(/\.[^/.]+$/, "") === entry.href);
                    entries.push(entry);
                }
            });
        }
        if (section.entries) {
            entries.push(...findEntriesWithLabel(section.entries, label, parentLabel));
        } else {
            // console.log('section.label', section);
        }
    });
    return entries;
};

// Define featured "Get started" pages - these will be large cards with icons
const featuredPages = [
    { label: "What is nf-core?", parent: undefined, icon: "octicon:play-16" },
    { label: "Overview", parent: "Environment setup", icon: "octicon:gear-16", overrideTitle: "Environment setup" },
    { label: "Run your first pipeline", parent: undefined, icon: "octicon:terminal-16" }
];

// Find featured page entries
const featuredEntries = featuredPages.map(({ label, parent, icon, overrideTitle }) => {
    const entries = findEntriesWithLabel(sections, label, parent);
    if (entries.length === 0) {
        console.warn(`No entry found for label: ${label} with parent: ${parent}`);
    }
    const entry = entries[0];
    if (entry) {
        entry.customIcon = icon;
        if (overrideTitle) {
            entry.overrideTitle = overrideTitle;
        }
    }
    return entry;
}).filter(Boolean);

// Define main sections with important pages
const mainSections = [
    {
        section: "Users",
        icon: "octicon:git-branch-16",
        pages: ["Configuration", "Reference genomes", "Run pipelines offline", "Advanced topics"]
    },
    {
        section: "Developers",
        icon: "octicon:git-commit-16",
        pages: ["Creating pipelines", "Adding modules to pipelines", "Testing", "Assertions"]
    },
    {
        section: "Contributors",
        icon: "octicon:git-pull-request-16",
        pages: ["How to contribute to nf-core", "Contribute components", "Pipeline release", "Reviewing pull requests"]
    },
    {
        section: "Specifications",
        icon: "octicon:checklist-16",
        pages: [
            { title: "Components", href: "/docs/specifications/components/overview" },
            { title: "Pipelines", href: "/docs/specifications/pipelines/overview" },
            { title: "Test data", href: "/docs/specifications/test-data/overview" }
        ]
    },
    {
        section: "Community",
        icon: "mdi:sprout",
        pages: ["Governance", "Brand", "Advisories"]
    },
    {
        section: "nf-core/tools",
        icon: "octicon:tools-16",
        pages: ["Installation", "Pipelines commands", "Components commands", "Schema commands"]
    }
];

// Find and attach metadata for main sections
const sectionCards = mainSections.map(({ section, icon, pages }) => {
    const pageEntries = pages.map(page => {
        // Handle custom page objects with title and href
        if (typeof page === 'object' && page.title && page.href) {
            return {
                label: page.title,
                href: page.href,
                metadata: { data: { title: page.title } }
            };
        }

        // Handle string-based pages (existing behavior)
        let pagePath = page;
        let parentLabel = pagePath.includes("/") ? pagePath.split("/")[0] : undefined;
        let label = parentLabel ? pagePath.split("/")[1] : pagePath;
        let entries = findEntriesWithLabel(sections, label, parentLabel?.replace("nf-core-tools", "nf-core/tools"));
        if (entries.length === 0) {
            console.warn(`No entry found for label: ${pagePath}`);
        }
        return entries[0];
    }).filter(Boolean);

    return {
        section: section,
        icon: icon,
        pages: pageEntries
    };
});
---

<PageLayout
    title="nf-core documentation"
    subtitle="How to use nf-core pipelines and contribute to the nf-core community"
    mainpage_container={false}
>
    <div class="container-fluid main-content">
        <div class="row">
            <div class="col-12 col-xl-8 order-2">
                <div class="index-content">
                    <!-- Featured Cards -->
                    <div class="featured-section mb-5">
                        <h2 class="section-heading mb-2">Get started</h2>
                        <p class="mb-4">
                            New to nf-core? Start here to learn the basics and run your first pipeline.
                        </p>
                    <div class="card-grid featured-grid">
                        {
                            featuredEntries.map((page) => (
                                <a href={page.href} class="text-decoration-none">
                                    <div class="card h-100 featured-card">
                                        <div class="card-body">
                                            <div class="featured-icon mb-3">
                                                <Icon name={page.customIcon} />
                                            </div>
                                            <h3 class="h5 card-title mb-0">{page.overrideTitle || page.metadata?.data.title || page.label}</h3>
                                        </div>
                                    </div>
                                </a>
                            ))
                        }
                    </div>
                </div>

                <!-- Main Sections -->
                <div class="mb-5">
                    <h2 class="section-heading mb-2">Recommended pages</h2>
                    <p class="mb-4">
                        Browse pages covering key concepts, guides, reference documentation, and troubleshooting.
                    </p>
                <div class="card-grid section-grid">
                    {
                        sectionCards.map((section) => (
                            <div class="card h-100 section-card">
                                <div class="card-header">
                                    <h3 class="mb-0 d-flex align-items-center">
                                        {section.icon && <Icon name={section.icon} class="me-2" />}
                                        {section.section}
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        {section.pages.map((page) => (
                                            <li class="mb-2">
                                                <a href={page.href} class="text-decoration-none">
                                                    {page.metadata?.data.title || page.label}
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        ))
                    }
                </div>
                </div>
                </div>
            </div>
            <div class="col-12 col-xl-3 sticky-top-under d-none d-xl-inline sidebar-left order-1">
                <SidebarNav items={sections} />
            </div>
        </div>
    </div>
</PageLayout>
<style>
    /* Index content wrapper - match markdown content width */
    .index-content {
        max-width: 50rem;
        width: 100%;
    }

    /* Intro Text */
    .intro-text {
        .lead {
            color: var(--bs-body-color);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 0;
        }
    }

    /* Section headings */
    .section-heading {
        color: var(--bs-heading-color);
        font-weight: 600;
        font-size: 1.75rem;
    }

    .section-subheading {
        color: var(--bs-secondary-color);
        font-size: 1.25rem;
        line-height: 1.5;
    }

    /* Card grid layouts */
    .card-grid {
        display: grid;
        gap: 1rem;
    }

    .featured-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
    }

    .section-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    @media (max-width: 991px) {
        .featured-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .section-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 767px) {
        .featured-grid,
        .section-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Featured "Get Started" Cards */
    .featured-card {
        border: 1px solid var(--bs-border-color);
        background: var(--bs-body-bg);
        transition: border-color 0.2s ease-in-out;

        &:hover {
            border-color: var(--bs-secondary);

            .card-title {
                text-decoration: underline;
            }
        }

        .card-body {
            padding: 1.5rem;
        }

        .featured-icon {
            font-size: 48px;
            line-height: 1;

            :global(svg) {
                width: 96px !important;
                height: 96px !important;
                color: var(--bs-primary);
            }
        }

        .card-title {
            color: var(--bs-heading-color);
            font-weight: 600;
            font-size: 1.25rem;
        }
    }

    /* Section Cards */
    .section-card {
        border: 1px solid var(--bs-border-color);

        .card-header {
            background-color: var(--bs-body-secondary-bg);
            border-bottom: 1px solid var(--bs-border-color);
            padding: 0.75rem 1rem;

            h3 {
                font-size: 1rem !important;
                font-weight: 600;
                line-height: 1.6;
            }

            :global(svg) {
                width: 20px;
                height: 20px;
            }
        }

        .card-body {
            padding: 1rem;
            font-size: 1rem;
        }

        a {
            color: var(--bs-link-color);
            font-size: 1rem;

            &:hover {
                text-decoration: underline !important;
            }
        }

        li {
            line-height: 1.6;
        }
    }
</style>
