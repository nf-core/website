---
import PageLayout from "@layouts/PageLayout.astro";
import { getCollection } from "astro:content";
import type { SidebarEntry } from "@utils/types";
import { addEntriesToSection, sanitizeNfCoreLabels } from "@utils/functions";
import { Icon } from "astro-icon/components";
import SidebarNav from "@components/sidebar/SidebarNav.astro";

let docs = await getCollection("docs");

let sections: SidebarEntry[] = [
    {
        type: "group",
        id: "get-started",
        label: "Get started",
        entries: [],
        collapsed: true,
        icon: "octicon:play-16",
        weight: 1,
    },
    {
        type: "group",
        id: "users",
        label: "Users",
        entries: [],
        collapsed: true,
        icon: "octicon:git-branch-16",
        weight: 2,
    },
    {
        type: "group",
        id: "developers",
        label: "Developers",
        entries: [],
        collapsed: true,
        icon: "octicon:git-commit-16",
        weight: 3,
    },
    {
        type: "group",
        id: "contributors",
        label: "Contributors",
        entries: [],
        collapsed: true,
        icon: "octicon:git-pull-request-16",
        weight: 4,
    },
    {
        type: "group",
        id: "specifications",
        label: "Specifications",
        entries: [],
        collapsed: true,
        icon: "octicon:checklist-16",
        weight: 5,
    },
    {
        type: "group",
        id: "community",
        label: "Community",
        entries: [],
        collapsed: true,
        icon: "mdi:sprout",
        weight: 6,
    },
    {
        type: "group",
        id: "nf-core-tools",
        label: "nf-core/tools",
        entries: [],
        collapsed: true,
        icon: "octicon:tools-16",
        weight: 7,
    },
];

addEntriesToSection(sections, docs, Astro.url.pathname);
// sort all entries by weight if available recursively
const sortEntries = (entries: SidebarEntry[]) => {
    entries.sort((a, b) => {
        if (a.weight && !b.weight) {
            return -1;
        } else if (!a.weight && b.weight) {
            return 1;
        } else if (a.weight && b.weight && a.weight !== b.weight) {
            if (a.weight < b.weight) {
                return -1;
            } else if (a.weight > b.weight) {
                return 1;
            }
        } else {
            return a.label.localeCompare(b.label);
        }
    });
    entries.forEach((entry) => {
        if (entry.type === "group" && entry.entries) {
            sortEntries(entry.entries);
        }
    });
};

sections.forEach((section) => {
    sortEntries(section.entries);
});

const findEntriesWithLabel = (sections: SidebarEntry[], label: string, parentLabel: string | undefined) => {
    let entries = [];
    sections.forEach((section) => {
        if (!parentLabel && section.label === label) {
            section.metadata = docs.find((doc) => "/docs/" + doc.id.replace(/\.[^/.]+$/, "") === section.href);
            entries.push(section);
        }
        if (parentLabel && section.label === parentLabel) {
            section.entries.forEach((entry) => {
                if (entry.label === label) {
                    entry.metadata = docs.find((doc) => "/docs/" + doc.id.replace(/\.[^/.]+$/, "") === entry.href);
                    entries.push(entry);
                }
            });
        }
        if (section.entries) {
            entries.push(...findEntriesWithLabel(section.entries, label, parentLabel));
        } else {
            // console.log('section.label', section);
        }
    });
    return entries;
};

// Define featured "Get started" pages - these will be large cards with icons
const featuredPages = [
    { title: "What is nf-core?", href: "/docs/get_started/nf-core", icon: "octicon:play-16" },
    { title: "Environment setup", href: "/docs/get_started/environment_setup/overview", icon: "octicon:gear-16" },
    {
        title: "Run your first pipeline",
        href: "/docs/get_started/run-your-first-pipeline",
        icon: "octicon:terminal-16",
    },
];

// Create featured page entries
const featuredEntries = featuredPages.map(({ title, href, icon }) => ({
    label: title,
    href: href,
    customIcon: icon,
    metadata: { data: { title: title } },
}));

// Define main sections with important pages
const mainSections = [
    {
        section: "Users",
        sectionHref: "/docs/users/",
        icon: "octicon:git-branch-16",
        pages: [
            { title: "How to run pipelines", href: "/docs/specifications/components/overview" },
            { title: "Configuration", href: "/docs/users/configuration/overview" },
            { title: "Run pipelines offline", href: "/docs/users/run-pipelines-offline" },
        ],
    },
    {
        section: "Developers",
        sectionHref: "/docs/developers/",
        icon: "octicon:git-commit-16",
        pages: [
            { title: "Create pipelines", href: "/docs/developers/components/create-components" },
            { title: "Create components", href: "/docs/developers/components/create-components" },
            { title: "Template syncs", href: "/docs/developers/template-syncs/overview" },
        ],
    },
    {
        section: "Contributors",
        sectionHref: "/docs/contributors/",
        icon: "octicon:git-pull-request-16",
        pages: [
            { title: "How to contribute to nf-core", href: "/docs/contributors/how-to-contribute-to-nf-core" },
            { title: "Project proposals", href: "/docs/contributors/project-proposals" },
            { title: "Review checklists", href: "/docs/contributors/" }
        ],
    },
    {
        section: "Specifications",
        sectionHref: "/docs/specifications/",
        icon: "octicon:checklist-16",
        pages: [
            { title: "Components", href: "/docs/specifications/components/overview" },
            { title: "Pipelines", href: "/docs/specifications/pipelines/overview" },
            { title: "Test data", href: "/docs/specifications/test-data/overview" },
        ],
    },
    {
        section: "Community",
        sectionHref: "/docs/community/",
        icon: "mdi:sprout",
        pages: [
            { title: "Advisories", href: "/docs/community/advisories" },
            { title: "Brand", href: "/docs/community/brand/overview" },
            { title: "Terminology", href: "/docs/community/terminology" },
        ],
    },
    {
        section: "nf-core/tools",
        sectionHref: "/docs/nf-core-tools/",
        icon: "octicon:tools-16",
        pages: [
            { title: "API", href: "/docs/nf-core-tools/api_reference" },
            { title: "Installation", href: "/docs/nf-core-tools/cli/installation" },
            { title: "TUI", href: "/docs/nf-core-tools/cli/tui" },
        ],
    },
];

// Find and attach metadata for main sections
const sectionCards = mainSections.map(({ section, sectionHref, icon, pages }) => {
    const pageEntries = pages
        .map((page) => {
            // Handle custom page objects with title and href
            if (typeof page === "object" && page.title && page.href) {
                return {
                    label: page.title,
                    href: page.href,
                    metadata: { data: { title: page.title } },
                };
            }

            // Handle string-based pages (existing behavior)
            let pagePath = page;
            let parentLabel = pagePath.includes("/") ? pagePath.split("/")[0] : undefined;
            let label = parentLabel ? pagePath.split("/")[1] : pagePath;
            let entries = findEntriesWithLabel(sections, label, parentLabel?.replace("nf-core-tools", "nf-core/tools"));
            if (entries.length === 0) {
                console.warn(`No entry found for label: ${pagePath}`);
            }
            return entries[0];
        })
        .filter(Boolean);

    return {
        section: section,
        sectionHref: sectionHref,
        icon: icon,
        pages: pageEntries,
    };
});

// Define training cards
const trainingCards = [
    {
        title: "Nextflow documentation",
        href: "https://www.nextflow.io/docs/latest/index.html",
        icon: "octicon:book-16",
    },
    {
        title: "Nextflow and nf-core training",
        href: "https://training.nextflow.io/latest/",
        icon: "octicon:mortar-board-16",
    },
];
---

<PageLayout
    title="nf-core documentation"
    subtitle="Learn to use nf-core pipelines, develop workflows, and contribute to the community"
    mainpage_container={false}
>
    <div class="container-fluid main-content">
        <div class="row">
            <div class="col-12 col-xl-8 order-2">
                <!-- Featured Cards -->
                <div class="featured-section mb-5">
                    <h2 class="section-heading mb-2">Get started</h2>
                    <p class="mb-4">New to nf-core? Start here to learn the basics and run your first pipeline.</p>
                    <div class="grid gap-3">
                        {
                            featuredEntries.map((page) => (
                                <a href={page.href} class="text-decoration-none g-col-12 g-col-md-6 g-col-lg-4">
                                    <div class="card h-100 featured-card">
                                            <div class="card-body">
                                                <div class="featured-icon mb-3">
                                                    <Icon name={page.customIcon} />
                                                </div>
                                                <h3 class="h5 card-title mb-0">
                                                    {page.overrideTitle || page.metadata?.data.title || page.label}
                                                </h3>
                                            </div>
                                    </div>
                                </a>
                            ))
                        }
                    </div>
                </div>

                <!-- Main Sections -->
                <div class="mb-5">
                    <h2 class="section-heading mb-2">Popular pages</h2>
                    <p class="mb-4">
                        Popular pages covering key concepts, guides, reference documentation, and troubleshooting.
                    </p>
                    <div class="grid gap-3">
                        {
                            sectionCards.map((section) => (
                                <div class="card h-100 section-card g-col-12 g-col-md-6 g-col-lg-4">
                                        <a href={section.sectionHref} class="card-header text-decoration-none">
                                            <h3 class="mb-0 d-flex align-items-center">
                                                {section.icon && <Icon name={section.icon} class="me-2" />}
                                                {section.section}
                                            </h3>
                                        </a>
                                    <div class="card-body">
                                        <ul class="list-unstyled mb-0">
                                            {section.pages.map((page) => (
                                                <li class="mb-2">
                                                    <a href={page.href} class="text-decoration-none">
                                                        {page.metadata?.data.title || page.label}
                                                    </a>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>

                <!-- Other Resources Section -->
                <div class="mb-5">
                    <h2 class="section-heading mb-2">Other resources</h2>
                    <p class="mb-4">
                        Learn Nextflow and nf-core through comprehensive documentation and hands-on training
                        materials.
                    </p>
                    <div class="grid gap-3">
                        {
                            trainingCards.map((card) => (
                                <a href={card.href} class="text-decoration-none g-col-12 g-col-md-6">
                                    <div class="card h-100 featured-card">
                                            <div class="card-body">
                                                <div class="featured-icon mb-3">
                                                    <Icon name={card.icon} />
                                                </div>
                                                <h3 class="h5 card-title mb-0">{card.title}</h3>
                                            </div>
                                    </div>
                                </a>
                            ))
                        }
                    </div>
                </div>
            </div>
            <div class="col-12 col-xl-3 sticky-top-under d-none d-xl-inline sidebar-left order-1">
                <SidebarNav items={sections} />
            </div>
        </div>
    </div>
</PageLayout>
<style>
    /* Intro Text */
    .intro-text {
        .lead {
            color: var(--bs-body-color);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 0;
        }
    }

    /* Section headings */
    .section-heading {
        color: var(--bs-heading-color);
        font-weight: 600;
        font-size: 1.75rem;
    }

    .section-subheading {
        color: var(--bs-secondary-color);
        font-size: 1.25rem;
        line-height: 1.5;
    }

    /* Featured "Get Started" Cards */
    .featured-card {
        border: 1px solid var(--bs-border-color);
        background: var(--bs-body-bg);
        transition: border-color 0.2s ease-in-out;

        &:hover {
            border-color: var(--bs-secondary);

            .card-title {
                text-decoration: underline;
            }
        }

        .card-body {
            padding: 1.5rem;
        }

        .featured-icon {
            font-size: 48px;
            line-height: 1;

            :global(svg) {
                width: 96px !important;
                height: 96px !important;
                color: var(--bs-primary);
            }
        }

        .card-title {
            color: var(--bs-heading-color);
            font-weight: 600;
            font-size: 1.25rem;
        }
    }

    /* Section Cards */
    .section-card {
        border: 1px solid var(--bs-border-color);

        .card-header {
            background-color: var(--bs-body-secondary-bg);
            border-bottom: 1px solid var(--bs-border-color);
            padding: 0.75rem 1rem;
            display: block;
            color: var(--bs-heading-color);
            transition: background-color 0.2s ease-in-out;

            &:hover {
                background-color: var(--bs-tertiary-bg);

                h3 {
                    text-decoration: underline;
                }
            }

            h3 {
                font-size: 1rem !important;
                font-weight: 600;
                line-height: 1.6;
                color: var(--bs-heading-color);
            }

            :global(svg) {
                width: 20px;
                height: 20px;
            }
        }

        .card-body {
            padding: 1rem;
            font-size: 1rem;

            a {
                color: var(--bs-link-color);
                font-size: 1rem;

                &:hover {
                    text-decoration: underline !important;
                }
            }
        }

        li {
            line-height: 1.6;
        }
    }
</style>
